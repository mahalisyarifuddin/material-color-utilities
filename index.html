<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Material Color Utilities - Quantize & Palette</title>
  <style>
    :root {
      --primary: #0070ea;
      --primary-hover: #005bc0;
      --background: #f9f9ff;
      --surface: #fff;
      --text: #414754;
      --border: #c1c6d7;
      --hover: #d7d9e5;
    }

    @media (prefers-color-scheme: dark) {
      :root:not(.light) {
        --background: #10131b;
        --surface: #181c23;
        --text: #c1c6d7;
        --border: #414754;
        --hover: #10131b;
      }
    }

    :root.dark {
      --background: #10131b;
      --surface: #181c23;
      --text: #c1c6d7;
      --border: #414754;
      --hover: #10131b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--background);
      color: var(--text);
      font-family: sans-serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }

    .container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-width: 720px;
      padding: 2rem;
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .hidden {
      display: none !important;
    }

    h1, h2 {
      margin: 0.5rem 0;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    input, select, textarea, button {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 1rem;
      padding: 0.5rem;
      width: 100%;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      transition: background 0.2s;
    }

    .button-primary {
      background: var(--primary);
      border: none;
      color: #fff;
    }

    .button-primary:hover {
      background: var(--primary-hover);
    }

    .button-secondary:hover {
      background: var(--hover);
    }

    .input-toggle {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .input-toggle button {
      flex: 1;
    }

    .input-toggle button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    #preview-image {
      max-width: 100%;
      max-height: 300px;
      margin-top: 1rem;
      border-radius: 4px;
      display: none;
      object-fit: contain;
      border: 1px solid var(--border);
    }

    #quantize-count {
      width: 60px;
      padding: 0.25rem;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .color-chip {
      height: 60px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      justify-content: end;
      padding: 4px;
      font-size: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-chip:hover {
      transform: scale(1.05);
      border-color: var(--primary);
    }

    .palette-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tonal-palette {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tonal-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tone-chip {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: transform 0.1s;
    }

    .tone-chip:hover {
      transform: scale(1.1);
      border-color: var(--text);
      z-index: 1;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--surface);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    #toast.visible {
      opacity: 1;
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>Material Color Utilities</h1>

    <div class="input-toggle">
      <button id="btn-mode-image" class="active button-secondary">Image</button>
      <button id="btn-mode-color" class="button-secondary">Color</button>
    </div>

    <div id="section-image">
      <label for="file-input">Upload Image</label>
      <input type="file" id="file-input" accept="image/*">
      <img id="preview-image" alt="Preview">

      <div id="quantize-container" class="hidden" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <label style="margin-bottom: 0;">Quantized Colors</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <label for="quantize-count" style="margin-bottom: 0; font-weight: normal; font-size: 0.85rem;">Count:</label>
            <input type="number" id="quantize-count" value="4" min="1" max="128">
          </div>
        </div>
        <div id="quantized-colors" class="color-grid"></div>
      </div>
    </div>

    <div id="section-color" class="hidden">
      <label>Pick a Color</label>
      <div class="input-row">
        <input type="color" id="color-picker" value="#0070ea" style="width: 50px; padding: 0; height: 42px;">
        <input type="text" id="hex-input" placeholder="#0070ea" value="#0070ea">
      </div>
    </div>

    <div id="palette-container" class="hidden">
      <h2>Core Palette</h2>
      <p style="font-size: 0.85rem; margin-bottom: 1rem; opacity: 0.8;">Click a color to copy hex code.</p>
      <div id="core-palette" class="palette-section"></div>
    </div>
  </div>

  <div id="toast">Copied!</div>

  <script type="module">
    import {
      QuantizerCelebi,
      Score,
      argbFromRgb,
      hexFromArgb,
      argbFromHex,
      CorePalette,
      Hct
    } from 'https://esm.sh/@material/material-color-utilities@0.2.7';

    const fileInput = document.getElementById('file-input');
    const previewImage = document.getElementById('preview-image');
    const quantizedContainer = document.getElementById('quantized-colors');
    const quantizeCountInput = document.getElementById('quantize-count');
    const quantizeSection = document.getElementById('quantize-container');
    const paletteContainer = document.getElementById('core-palette');
    const paletteWrapper = document.getElementById('palette-container');
    const colorPicker = document.getElementById('color-picker');
    const hexInput = document.getElementById('hex-input');
    const btnModeImage = document.getElementById('btn-mode-image');
    const btnModeColor = document.getElementById('btn-mode-color');
    const sectionImage = document.getElementById('section-image');
    const sectionColor = document.getElementById('section-color');
    const toast = document.getElementById('toast');

    const tones = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 95, 99, 100];

    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2000);
    };

    const copyToClipboard = (hex) => {
      navigator.clipboard.writeText(hex).then(
        () => showToast(`Copied ${hex}`),
        () => showToast(`Failed to copy ${hex}`)
      );
    };

    const createColorChip = (argb) => {
      const hex = hexFromArgb(argb);
      const tone = Math.round(Hct.fromInt(argb).tone);
      const chip = document.createElement('div');
      chip.className = 'color-chip';
      chip.style.backgroundColor = hex;
      chip.title = `${hex} Tone: ${tone}`;
      chip.onclick = () => displayPalette(argb);
      return chip;
    };

    const createToneChip = (argb, tone) => {
      const hex = hexFromArgb(argb);
      const chip = document.createElement('div');
      chip.className = 'tone-chip';
      chip.style.backgroundColor = hex;
      chip.title = `${hex} (Tone ${tone})`;
      chip.onclick = () => copyToClipboard(hex);
      return chip;
    };

    const displayQuantizedColors = (scoredColors) => {
      quantizeSection.classList.remove('hidden');
      quantizedContainer.innerHTML = '';
      scoredColors.map(argb =>
        quantizedContainer.appendChild(createColorChip(argb))
      );
    };

    const displayPalette = (sourceArgb) => {
      paletteContainer.innerHTML = '';
      paletteWrapper.classList.remove('hidden');
      const corePalette = CorePalette.of(sourceArgb);

      const paletteMap = {
        'Primary': corePalette.a1,
        'Secondary': corePalette.a2,
        'Tertiary': corePalette.a3,
        'Neutral': corePalette.n1,
        'Neutral Variant': corePalette.n2,
        'Error': corePalette.error
      };

      Object.entries(paletteMap).map(([name, palette]) => {
        const rowContainer = document.createElement('div');
        rowContainer.className = 'tonal-palette';

        const label = document.createElement('div');
        label.textContent = name;
        label.style.fontSize = '0.85rem';
        label.style.fontWeight = 'bold';
        rowContainer.appendChild(label);

        const row = document.createElement('div');
        row.className = 'tonal-row';

        tones.map(tone => {
          const argb = palette.tone(tone);
          row.appendChild(createToneChip(argb, tone));
        });

        rowContainer.appendChild(row);
        paletteContainer.appendChild(rowContainer);
      });
    };

    const processImage = async (img) => {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      const maxDimension = 128;
      const scale = Math.min(1, maxDimension / Math.max(img.naturalWidth, img.naturalHeight));

      canvas.width = Math.floor(img.naturalWidth * scale);
      canvas.height = Math.floor(img.naturalHeight * scale);

      context.drawImage(img, 0, 0, canvas.width, canvas.height);

      const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
      const pixels = [];

      for (let i = 0; i < imageData.length; i += 4) {
        const r = imageData[i];
        const g = imageData[i + 1];
        const b = imageData[i + 2];
        const a = imageData[i + 3];
        (a < 255) ? null : pixels.push(argbFromRgb(r, g, b));
      }

      const result = QuantizerCelebi.quantize(pixels, 128);
      const count = parseInt(quantizeCountInput.value, 10) || 4;
      const ranked = Score.score(result, { desired: count });

      displayQuantizedColors(ranked);
      (ranked.length > 0) ? displayPalette(ranked[0]) : null;
    };

    quantizeCountInput.onchange = () => {
      (previewImage.src && previewImage.style.display !== 'none') ? processImage(previewImage) : null;
    };

    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = (event) => {
        previewImage.src = event.target.result;
        previewImage.style.display = 'block';
      };

      previewImage.onload = () => {
        processImage(previewImage);
      };

      (file) ? reader.readAsDataURL(file) : null;
    };

    const handleColorInput = (hex) => {
      try {
        const argb = argbFromHex(hex);
        displayPalette(argb);
      } catch (e) {
        null;
      }
    };

    colorPicker.oninput = (e) => {
      hexInput.value = e.target.value;
      handleColorInput(e.target.value);
    };

    hexInput.oninput = (e) => {
      const val = e.target.value;
      (val.startsWith('#') && (val.length === 4 || val.length === 7)) ?
        (colorPicker.value = val, handleColorInput(val)) : null;
    };

    const toggleMode = (mode) => {
      const isImage = mode === 'image';

      btnModeImage.classList.toggle('active', isImage);
      btnModeColor.classList.toggle('active', !isImage);

      sectionImage.classList.toggle('hidden', !isImage);
      sectionColor.classList.toggle('hidden', isImage);

      (!isImage && hexInput.value) ? handleColorInput(hexInput.value) :
        (previewImage.src && previewImage.style.display !== 'none') ? processImage(previewImage) :
        (paletteWrapper.classList.add('hidden'));
    };

    btnModeImage.onclick = () => toggleMode('image');
    btnModeColor.onclick = () => toggleMode('color');
  </script>
</body>
</html>
